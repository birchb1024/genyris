@prefix u   "http://www.genyris.org/lang/utilities#"
@prefix t   "http://www.genyris.org/lib/gunit#"
@prefix web "http://www.genyris.org/lang/web#"

include "testscripts/gunit.lin"

def readPage(url)
    var wstream (web.get url)
    var count 0
    while (wstream(!hasData))
         setq count (+ count 1)
         write (wstream(!read)) '-
    wstream(!close)
    u.format "~%Read ~a bytes~%" count
    count


var overall-result
  t.test "Web Server"
    t.test "Spawn and Kill"
        t.given (web.serve 7777 "testscripts/www-text.lin") expect 8
        t.given (sleep 2000) expect nil
        t.given (kill 7) expect "Interrupted ReaderThread"

    t.test "Spawn and HTTP Get"
        t.given (web.serve 7778 "testscripts/www-text.lin") expect 9
        t.given (sleep 2000) expect nil
        t.given (readPage "http://localhost:7777/") expect 15
        kill 8
or overall-result (raise "Web Suite Failed")
