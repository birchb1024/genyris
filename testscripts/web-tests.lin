@prefix u   "http://www.genyris.org/lang/utilities#"
@prefix t   "http://www.genyris.org/lib/gunit#"
@prefix web "http://www.genyris.org/lang/web#"

include "testscripts/gunit.lin"

def readPage(url)
    var wstream (web.get url)
    var count 0
    while (wstream(!hasData))
         setq count (+ count 1)
         write (wstream(!read)) '-
    wstream(!close)
    u.format "~%Read ~a bytes~%" count
    count

def run-web(port)
    var thread-id (web.serve port "testscripts/www-text.lin")
    sleep 2000
    kill thread-id

def run-web-get()
    var thread-id (web.serve 7778 "testscripts/www-text.lin")
    sleep 2000
    var result (readPage "http://localhost:7778/")
    kill thread-id
    result

def run-web-static-get()
    var thread-id (web.serve-static 7779 ".")
    sleep 2000
    var result (readPage "http://localhost:7779/LICENSE")
    kill thread-id
    result

var overall-result
  t.test "Web Server"
    t.test "Spawn and Kill"
        t.given (run-web 7777) expect "Interrupted GenyrisHTTPD-7777"

    t.test "Spawn and HTTP Get"
         t.given (run-web-get 7778) expect 15

    t.test "Static server and HTTP Get"
         t.given (run-web-static-get 7779) expect 1558

or overall-result (raise "Web Suite Failed")
