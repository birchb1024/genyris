<project name="Genyris" default="all" basedir=".">

    <property name="needed.lib.dir" value="needed" />
    <property name="junit.lib.dir" value="needed" />
    <property name="build.dir" value="build" />
    <property name="dist.dir" value="dist" />
    <property name="src.compile.dir" value="${build.dir}/classes" />
    <property name="src.dir" value="src" />

    <property name="web.dir" value="web/war" />
    <property name="output.war" value="${dist.dir}/genyris.war" />
    <property name="output.ear" value="${dist.dir}/genyris.ear" />
    <property name="ear.project.root" value="web/ear" />
    <property name="installed.apps.war" value="C:\ibm\WebSphere\profiles\wp_profile\installedApps\w0019\Genyris.ear\genyris.war" />

    <target name="all" depends="only-clean, only-init, only-compile, only-war, only-ear, only-binary-jar" description="Build all." />
    <target name="clean" depends="only-clean" />

    <target name="compile" depends="only-clean, only-init, only-compile"
        description="Compile the Java"/>
    <target name="binary-jar" depends="compile, only-binary-jar"
         description="compile and create jar"/>
    <target name="war" depends="binary-jar, only-war"
        description="Create war file, always compile."/>
    <target name="ear" depends="war, only-ear"
        description="Create ear file, compile as needed."/>

    <!-- Libraries required  -->
    <fileset id="needed.libs" dir="${needed.lib.dir}">
        <include name="bsf.jar" />
        <include name="commons-logging-1.1.jar" />
        <include name="servlet-api.jar" />
        <include name="junit.jar" />
    </fileset>

    <!-- Libraries required in the web classpath. -->
    <fileset id="web-inf.libs" dir="${needed.lib.dir}">
        <include name="bsf.jar" />
        <include name="commons-logging-1.1.jar" />
    </fileset>

    <!-- Servlet Libraries, release should not include these. -->
    <fileset id="servlet.libs" dir="${needed.lib.dir}">
        <include name="servlet-api.jar" />
    </fileset>

    <!-- Properties files from the classpath -->
    <fileset id="product.properties.files" dir="${java.src.dir}">
        <include name="*.properties" />
    </fileset>

    <!-- Classpath for JUnit testing -->
    <fileset id="junit.libs" file="${junit.lib.dir}/junit.jar" />


    <!-- ================================================================== -->
    <!--                        Classpaths                                  -->
    <!-- ================================================================== -->
    <path id="src.compile.classpath">
        <fileset refid="needed.libs" />
        <fileset refid="web-inf.libs" />
        <fileset refid="servlet.libs" />
        <fileset refid="junit.libs" />
    </path>

    <!-- ================================================================== -->
    <!--                        Targets                                     -->
    <!-- ================================================================== -->
    <target name="debug">
        <echoproperties />
    </target>

    <target name="only-init">
        <mkdir dir="${build.dir}" />
        <mkdir dir="${dist.dir}" />
        <mkdir dir="${src.compile.dir}" />
    </target>

    <target name="only-clean">
        <delete dir="${build.dir}" />
        <delete dir="${dist.dir}" />
    </target>

    <target name="only-compile">
        <javac srcdir="${src.dir}" destdir="${src.compile.dir}"
            classpathref="src.compile.classpath"
                source="1.4"
            target="1.4"
            verbose="no">
            <include name="org/**" />
        </javac>
    </target>

	<target name="archive">
	    <input message="Destination directory for archive?" addproperty="archive.dest"/>
	    <tstamp/>
	    
		<jar destfile="${archive.dest}/genyris-archive-${DSTAMP}${TSTAMP}.jar" 
				duplicate="fail"
				defaultexcludes="no">
			<fileset dir="${basedir}" includes="*" />
			<fileset dir="${basedir}" includes="*/**/*">
				  <exclude name="idebuild/**/*"/>
				  <exclude name="build/**/*"/>
			</fileset>
		</jar>
	</target>

    <target name="only-binary-jar">
        <jar destfile="${dist.dir}/genyris-bin.jar"  duplicate="fail">
            <fileset dir="${basedir}" includes="README LICENSE" />
            <fileset dir="${src.compile.dir}" includes="**/*.class" excludes="**/GenyrisServlet.class" />
            <fileset dir="${needed.lib.dir}" includes="junit/**/*" />
            <fileset dir="${src.dir}" includes="**/*.lin" />
            <fileset dir="${src.dir}" includes="**/*.properties" />
            <fileset dir="${basedir}" includes="examples/*.lin" />
            <fileset dir="${basedir}" includes="testscripts/*.lin testscripts/*.lsp" />
            <manifest>
            <attribute name="Built-By" value="Peter William Birch"/>
            <attribute name="Main-Class" value="org.genyris.interp.ClassicReadEvalPrintLoop"/>
            </manifest>
        </jar>
    </target>



    <target name="only-war">
        <delete file="${output.war}"/>
        <copy todir="${web.dir}/WEB-INF/lib">
            <fileset file="${dist.dir}/genyris-bin.jar" />
        </copy>
        <copy todir="${web.dir}/WEB-INF/classes">
            <fileset dir="${build.dir}/classes">
                <include name="org/genyris/web/GenyrisServlet.class" />
            </fileset>
        </copy>
        <war destfile="${output.war}" webxml="${web.dir}/WEB-INF/web.xml" manifest="${web.dir}/META-INF/MANIFEST.MF">
            <zipfileset dir="${web.dir}">
                <exclude name="**/WEB-INF/**/*" />
            </zipfileset>
            <webinf dir="${web.dir}/WEB-INF">
                <exclude name="**/web.xml" />
            </webinf>
        </war>
    </target>

    <!-- Generates the ${war.project.name} ear file for deployment -->
    <target name="only-ear">
        <delete file="${output.ear}" />
        <ear appxml="${ear.project.root}/META-INF/application.xml" destfile="${output.ear}">
            <fileset file="${output.war}" />
        </ear>
    </target>

    <!-- hot deploy the jsp and class files to make a simple update in the development environment -->
    <target name="only-hot-deploy-war">
        <copy todir="${installed.apps.war}" >
            <fileset dir="${web.dir}" />
        </copy>
    </target>

</project>